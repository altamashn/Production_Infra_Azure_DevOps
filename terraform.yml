trigger:
  branches:
    include:
      - feature/*
      - master
pr:
  branches:
    include:
      - master
      
pool:
  vmImage: ubuntu-latest

variables:
  - group: 'Backend-Details'

stages:
  - stage: Validate
    displayName: 'Terraform Validation Feature Branch'
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/'))
    jobs:
      - job: 'ValidateJob' 
        displayName: 'Run Terraform Validate & Plan'
        steps:
          - task: TerraformInstaller@1
            displayName: 'Terraform Install latest version'
            inputs:
              terraformVersion: 'latest'

          
          - task: TerraformTask@5
            displayName: 'Terraform Initialize'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              backendServiceArm: 'Terraform-DevOps'
              backendAzureRmResourceGroupName: '$(resource_group_name)'
              backendAzureRmStorageAccountName: '$(storage_account_name)'
              backendAzureRmContainerName: '$(container_name)'
              backendAzureRmKey: '$(key)'
              backendAzureRmUseEntraIdForAuthentication: false
              
          - task: TerraformTask@5
            displayName: 'Terraform Validate'
            inputs:
              provider: 'azurerm'
              command: 'validate'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
          - task: TerraformTask@5
            displayName: 'Terraform Format'
            inputs:
              provider: 'azurerm'
              command: 'custom'
              outputTo: 'console'
              customCommand: 'fmt'
              environmentServiceNameAzureRM: 'Terraform-DevOps'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
          - task: TerraformTask@5
            displayName: 'Terraform Show'
            inputs:
              provider: 'azurerm'
              command: 'show'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              outputTo: 'file'
              outputFormat: 'default'
              fileName: 'terraform-plan'
              environmentServiceNameAzureRM: 'Terraform-DevOps'
          - task: TerraformTask@5
            displayName: 'Terraform Plan - Feature Branch'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              environmentServiceNameAzureRM: 'Terraform-DevOps'
          - task: ArchiveFiles@2
            displayName: 'Archive Files'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)/Infrastructure'
              includeRootFolder: true
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Terraform Apply - Main Branch'
    condition: eq(variables['Build.SourceBranchName'], 'master')
    jobs:
      - job: ApplyJob
        displayName: 'Run Terraform Apply'
        steps:
        
          - task: TerraformInstaller@1
            displayName: 'Terraform latest version Install'
            inputs:
              terraformVersion: 'latest'
          - task: TerraformTask@5
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              backendServiceArm: 'Terraform-DevOps'
              backendAzureRmResourceGroupName: '$(resource_group_name)'
              backendAzureRmStorageAccountName: '$(storage_account_name)'
              backendAzureRmContainerName: '$(container_name)'
              backendAzureRmKey: '$(key)'
              backendAzureRmUseEntraIdForAuthentication: false
          - task: TerraformTask@5
            displayName: 'Terraform Plan'
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              environmentServiceNameAzureRM: 'Terraform-DevOps'
          - task: DownloadBuildArtifacts@1
            displayName: 'Download Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'drop'
              downloadPath: '$(Pipeline.Workspace)'

          - task: ExtractFiles@1
            displayName: 'Extract Files'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)/Infrastructure'
              cleanDestinationFolder: true
              overwriteExistingFiles: true
          - task: TerraformTask@5
            displayName: 'Terraform Apply (Main Branch)'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/Infrastructure'
              environmentServiceNameAzureRM: 'Terraform-DevOps'